<!DOCTYPE html>
<html class="no-js" lang="zh">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Rotate Columns (hard version) - 洛谷</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="renderer" content="webkit">
<meta name="csrf-token" content="1573403278:ecf10LzEWLsSKORGIEtt6gbQOxxzY8GnQfUoGqgUkvQ=">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" media="screen"/>
<link rel="stylesheet" href="https://cdn.luogu.com.cn/fe/loader.css?ver=20191106">
<script>window._feInjection = JSON.parse(decodeURIComponent("%7B%22code%22%3A200%2C%22currentTemplate%22%3A%22ProblemShow%22%2C%22currentData%22%3A%7B%22problem%22%3A%7B%22background%22%3Anull%2C%22description%22%3A%22This%20is%20a%20harder%20version%20of%20the%20problem.%20The%20difference%20is%20only%20in%20constraints.%5Cn%5CnYou%20are%20given%20a%20rectangular%20%24%20n%20%5C%5Ctimes%20m%20%24%20matrix%20%24%20a%20%24%20.%20In%20one%20move%20you%20can%20choose%20any%20column%20and%20cyclically%20shift%20elements%20in%20this%20column.%20You%20can%20perform%20this%20operation%20as%20many%20times%20as%20you%20want%20%28possibly%20zero%29.%20You%20can%20perform%20this%20operation%20to%20a%20column%20multiple%20times.%5Cn%5CnAfter%20you%20are%20done%20with%20cyclical%20shifts%2C%20you%20compute%20for%20every%20row%20the%20maximal%20value%20in%20it.%20Suppose%20that%20for%20%24%20i%20%24%20-th%20row%20it%20is%20equal%20%24%20r_i%20%24%20.%20What%20is%20the%20maximal%20possible%20value%20of%20%24%20r_1%2Br_2%2B%5C%5Cldots%2Br_n%20%24%20%3F%22%2C%22inputFormat%22%3A%22The%20first%20line%20contains%20an%20integer%20%24%20t%20%24%20%28%20%24%201%20%5C%5Cle%20t%20%5C%5Cle%2040%20%24%20%29%2C%20the%20number%20of%20test%20cases%20in%20the%20input.%5Cn%5CnThe%20first%20line%20of%20each%20test%20case%20contains%20integers%20%24%20n%20%24%20and%20%24%20m%20%24%20%28%20%24%201%20%5C%5Cle%20n%20%5C%5Cle%2012%20%24%20%2C%20%24%201%20%5C%5Cle%20m%20%5C%5Cle%202000%20%24%20%29%20%5Cu2014%20the%20number%20of%20rows%20and%20the%20number%20of%20columns%20in%20the%20given%20matrix%20%24%20a%20%24%20.%5Cn%5CnEach%20of%20the%20following%20%24%20n%20%24%20lines%20contains%20%24%20m%20%24%20integers%2C%20the%20elements%20of%20%24%20a%20%24%20%28%20%24%201%20%5C%5Cle%20a_%7Bi%2C%20j%7D%20%5C%5Cle%2010%5E5%20%24%20%29.%22%2C%22outputFormat%22%3A%22Print%20%24%20t%20%24%20integers%3A%20answers%20for%20all%20test%20cases%20in%20the%20order%20they%20are%20given%20in%20the%20input.%22%2C%22samples%22%3A%5B%5B%22%5Cn3%5Cn2%203%5Cn2%205%207%5Cn4%202%204%5Cn3%206%5Cn4%201%205%202%2010%204%5Cn8%206%206%204%209%2010%5Cn5%204%209%205%208%207%5Cn3%203%5Cn9%209%209%5Cn1%201%201%5Cn1%201%201%5Cn%22%2C%22%5Cn12%5Cn29%5Cn27%5Cn%22%5D%5D%2C%22hint%22%3A%22In%20the%20first%20test%20case%20you%20can%20shift%20the%20third%20column%20down%20by%20one%2C%20this%20way%20there%20will%20be%20%24%20r_1%20%3D%205%20%24%20and%20%24%20r_2%20%3D%207%20%24%20.%5Cn%5CnIn%20the%20second%20case%20you%20can%20don%27t%20rotate%20anything%20at%20all%2C%20this%20way%20there%20will%20be%20%24%20r_1%20%3D%20r_2%20%3D%2010%20%24%20and%20%24%20r_3%20%3D%209%20%24%20.%22%2C%22provider%22%3A%7B%22uid%22%3A3%2C%22name%22%3A%22%5Cu6d1b%5Cu8c37%22%2C%22slogan%22%3A%22%22%2C%22badge%22%3A%22%22%2C%22isAdmin%22%3Atrue%2C%22color%22%3A%22Purple%22%2C%22ccfLevel%22%3A0%7D%2C%22canEdit%22%3Afalse%2C%22limits%22%3A%7B%22time%22%3A%5B3000%5D%2C%22memory%22%3A%5B256000%5D%7D%2C%22stdCode%22%3A%22%22%2C%22vjudge%22%3A%7B%22origin%22%3A%22CodeForces%22%2C%22link%22%3A%22http%3A%5C%2F%5C%2Fcodeforces.com%5C%2Fproblemset%5C%2Fproblem%5C%2F1209%5C%2FE2%22%2C%22id%22%3A%221209E2%22%7D%2C%22translation%22%3A%22%5Cu7ed9%5Cu5b9a%5Cu4e00%5Cu4e2a%20%24n%20%5C%5Ctimes%20m%24%20%5Cu7684%5Cu77e9%5Cu9635%5Cuff0c%5Cu4f60%5Cu53ef%5Cu4ee5%5Cu5bf9%5Cu6bcf%5Cu4e00%5Cu5217%5Cu8fdb%5Cu884c%5Cu82e5%5Cu5e72%5Cu6b21%5Cu5faa%5Cu73af%5Cu79fb%5Cu4f4d%5Cr%5Cn%5Cr%5Cn%5Cu6c42%5Cu64cd%5Cu4f5c%5Cu5b8c%5Cu6210%5Cu540e%5Cu6bcf%5Cu4e00%5Cu884c%5Cu7684%5Cu6700%5Cu5927%5Cu503c%5Cu4e4b%5Cu548c%22%2C%22tags%22%3A%5B%5D%2C%22wantsTranslation%22%3Afalse%2C%22totalSubmit%22%3A159%2C%22totalAccepted%22%3A69%2C%22pid%22%3A%22CF1209E2%22%2C%22title%22%3A%22Rotate%20Columns%20%28hard%20version%29%22%2C%22difficulty%22%3A0%2C%22type%22%3A%22CF%22%7D%2C%22contest%22%3Anull%2C%22discussions%22%3A%5B%7B%22id%22%3A146878%2C%22title%22%3A%22%5Cu9898%5Cu76ee%5Cu6765%5Cu6e90%5Cu7684link%5Cu9505%5Cu4e86%22%2C%22forum%22%3A%7B%22id%22%3A40629%2C%22name%22%3A%22CF1209E2%20Rotate%20Columns%20%28hard%20version%29%22%2C%22slug%22%3A%22CF1209E2%22%7D%7D%5D%2C%22bookmarked%22%3Afalse%2C%22vjudgeUsername%22%3Anull%2C%22recommendations%22%3A%5B%7B%22pid%22%3A%22CF1214E%22%2C%22title%22%3A%22Petya%20and%20Construction%20Set%22%2C%22difficulty%22%3A0%2C%22type%22%3A%22CF%22%7D%2C%7B%22pid%22%3A%22CF1209F%22%2C%22title%22%3A%22Koala%20and%20Notebook%22%2C%22difficulty%22%3A0%2C%22type%22%3A%22CF%22%7D%2C%7B%22pid%22%3A%22CF1209E1%22%2C%22title%22%3A%22Rotate%20Columns%20%28easy%20version%29%22%2C%22difficulty%22%3A0%2C%22type%22%3A%22CF%22%7D%2C%7B%22pid%22%3A%22CF1215A%22%2C%22title%22%3A%22Yellow%20Cards%22%2C%22difficulty%22%3A0%2C%22type%22%3A%22CF%22%7D%2C%7B%22pid%22%3A%22CF1220E%22%2C%22title%22%3A%22Tourism%22%2C%22difficulty%22%3A0%2C%22type%22%3A%22CF%22%7D%5D%2C%22lastLanguage%22%3A%22%22%2C%22lastCode%22%3A%22%22%7D%2C%22currentTitle%22%3A%22Rotate%20Columns%20%28hard%20version%29%22%2C%22currentTheme%22%3Anull%7D"));window._feConfigVersion=1572920822;</script>
<script src="https://cdn.luogu.com.cn/fe/loader.js?ver=20191106" charset="utf-8" defer></script>
</head>
<body>
<div id="app">
<div class="lg-container">
<article>
<h1>Rotate Columns (hard version)</h1>
<h2>题意翻译</h2>
<div>给定一个 $n \times m$ 的矩阵，你可以对每一列进行若干次循环移位
求操作完成后每一行的最大值之和</div>
<h2>题目描述</h2>
<div>This is a harder version of the problem. The difference is only in constraints.
You are given a rectangular $ n \times m $ matrix $ a $ . In one move you can choose any column and cyclically shift elements in this column. You can perform this operation as many times as you want (possibly zero). You can perform this operation to a column multiple times.
After you are done with cyclical shifts, you compute for every row the maximal value in it. Suppose that for $ i $ -th row it is equal $ r_i $ . What is the maximal possible value of $ r_1+r_2+\ldots+r_n $ ?</div>
<h2>输入输出格式</h2>
<h3>输入格式</h3>
<br />
<div>The first line contains an integer $ t $ ( $ 1 \le t \le 40 $ ), the number of test cases in the input.
The first line of each test case contains integers $ n $ and $ m $ ( $ 1 \le n \le 12 $ , $ 1 \le m \le 2000 $ ) — the number of rows and the number of columns in the given matrix $ a $ .
Each of the following $ n $ lines contains $ m $ integers, the elements of $ a $ ( $ 1 \le a_{i, j} \le 10^5 $ ).</div>
<h3>输出格式</h3>
<br />
<div>Print $ t $ integers: answers for all test cases in the order they are given in the input.</div>
<h2>输入输出样例</h2>
<h3>输入样例 #1</h3>
<pre><code>
3
2 3
2 5 7
4 2 4
3 6
4 1 5 2 10 4
8 6 6 4 9 10
5 4 9 5 8 7
3 3
9 9 9
1 1 1
1 1 1
</code></pre>
<h3>输出样例 #1</h3>
<pre><code>
12
29
27
</code></pre>
<h2>说明</h2>
<div>In the first test case you can shift the third column down by one, this way there will be $ r_1 = 5 $ and $ r_2 = 7 $ .
In the second case you can don't rotate anything at all, this way there will be $ r_1 = r_2 = 10 $ and $ r_3 = 9 $ .</div>
</article>
</div>
</div>
</body>
</html>
