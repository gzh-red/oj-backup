<!DOCTYPE html>
<html class="no-js" lang="zh">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Boolean Function - 洛谷</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="renderer" content="webkit">
<meta name="csrf-token" content="1573395632:/rxkwVrLEsQhPlnsBzgahTtkybF4fuG7mhvP5VNFwQg=">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" media="screen"/>
<link rel="stylesheet" href="https://cdn.luogu.com.cn/fe/loader.css?ver=20191106">
<script>window._feInjection = JSON.parse(decodeURIComponent("%7B%22code%22%3A200%2C%22currentTemplate%22%3A%22ProblemShow%22%2C%22currentData%22%3A%7B%22problem%22%3A%7B%22background%22%3A%22%22%2C%22description%22%3A%22In%20this%20problem%20we%20consider%20Boolean%20functions%20of%20four%20variables%20%24%20A%2CB%2CC%2CD%20%24%20.%20Variables%20%24%20A%2CB%2CC%20%24%20and%20%24%20D%20%24%20are%20logical%20and%20can%20take%20values%200%20or%201.%20We%20will%20define%20a%20function%20using%20the%20following%20grammar%3A%5Cn%5Cn%3Cexpression%3E%20%3A%3A%3D%20%3Cvariable%3E%20%7C%20%28%3Cexpression%3E%29%20%3Coperator%3E%20%28%3Cexpression%3E%29%5Cn%5Cn%3Cvariable%3E%20%3A%3A%3D%20%27A%27%20%7C%20%27B%27%20%7C%20%27C%27%20%7C%20%27D%27%20%7C%20%27a%27%20%7C%20%27b%27%20%7C%20%27c%27%20%7C%20%27d%27%5Cn%5Cn%3Coperator%3E%20%3A%3A%3D%20%27%26%27%20%7C%20%27%7C%27%5Cn%5CnHere%20large%20letters%20%24%20A%2CB%2CC%2CD%20%24%20represent%20variables%2C%20and%20small%20letters%20represent%20their%20negations.%20For%20example%2C%20if%20%24%20A%3D1%20%24%20%2C%20then%20character%20%27A%27%20corresponds%20to%20value%201%2C%20and%20value%20character%20%27a%27%20corresponds%20to%20value%200.%20Here%20character%20%27%26%27%20corresponds%20to%20the%20operation%20of%20logical%20AND%2C%20character%20%27%7C%27%20corresponds%20to%20the%20operation%20of%20logical%20OR.%5Cn%5CnYou%20are%20given%20expression%20%24%20s%20%24%20%2C%20defining%20function%20%24%20f%20%24%20%2C%20where%20some%20operations%20and%20variables%20are%20missing.%20Also%20you%20know%20the%20values%20of%20the%20function%20%24%20f%28A%2CB%2CC%2CD%29%20%24%20for%20some%20%24%20n%20%24%20distinct%20sets%20of%20variable%20values.%20Count%20the%20number%20of%20ways%20to%20restore%20the%20elements%20that%20are%20missing%20in%20the%20expression%20so%20that%20the%20resulting%20expression%20corresponded%20to%20the%20given%20information%20about%20function%20%24%20f%20%24%20in%20the%20given%20variable%20sets.%20As%20the%20value%20of%20the%20result%20can%20be%20rather%20large%2C%20print%20its%20remainder%20modulo%20%24%2010%5E%7B9%7D%2B7%20%24%20.%22%2C%22inputFormat%22%3A%22The%20first%20line%20contains%20expression%20%24%20s%20%24%20%28%20%24%201%3C%3D%7Cs%7C%3C%3D500%20%24%20%29%2C%20where%20some%20characters%20of%20the%20operators%20and%5C%2For%20variables%20are%20replaced%20by%20character%20%27%3F%27.%5Cn%5CnThe%20second%20line%20contains%20number%20%24%20n%20%24%20%28%20%24%200%3C%3Dn%3C%3D2%5E%7B4%7D%20%24%20%29%20%5Cu2014%20the%20number%20of%20integers%20sets%20for%20which%20we%20know%20the%20value%20of%20function%20%24%20f%28A%2CB%2CC%2CD%29%20%24%20.%20Next%20%24%20n%20%24%20lines%20contain%20the%20descriptions%20of%20the%20sets%3A%20the%20%24%20i%20%24%20-th%20of%20them%20contains%20five%20integers%20%24%20a_%7Bi%7D%2Cb_%7Bi%7D%2Cc_%7Bi%7D%2Cd_%7Bi%7D%2Ce_%7Bi%7D%20%24%20%28%20%24%200%3C%3Da_%7Bi%7D%2Cb_%7Bi%7D%2Cc_%7Bi%7D%2Cd_%7Bi%7D%2Ce_%7Bi%7D%3C%3D1%20%24%20%29%2C%20separated%20by%20spaces%20and%20meaning%20that%20%24%20f%28a_%7Bi%7D%2Cb_%7Bi%7D%2Cc_%7Bi%7D%2Cd_%7Bi%7D%29%3De_%7Bi%7D%20%24%20.%5Cn%5CnIt%20is%20guaranteed%20that%20all%20the%20tuples%20%28%20%24%20a_%7Bi%7D%2Cb_%7Bi%7D%2Cc_%7Bi%7D%2Cd_%7Bi%7D%20%24%20%29%20are%20distinct.%22%2C%22outputFormat%22%3A%22In%20a%20single%20line%20print%20the%20answer%20to%20the%20problem.%22%2C%22samples%22%3A%5B%5B%22%3F%5Cn2%5Cn1%200%201%200%201%5Cn0%201%201%200%201%5Cn%22%2C%222%5Cn%22%5D%2C%5B%22%28A%29%3F%28%3F%29%5Cn1%5Cn1%201%200%200%200%5Cn%22%2C%224%5Cn%22%5D%2C%5B%22%28%28%3F%29%26%28%3F%29%29%7C%28%28%3F%29%26%28%3F%29%29%5Cn0%5Cn%22%2C%224096%22%5D%2C%5B%22b%5Cn1%5Cn1%200%201%201%201%5Cn%22%2C%221%5Cn%22%5D%5D%2C%22hint%22%3A%22In%20the%20first%20sample%20the%20two%20valid%20expressions%20are%20%27C%27%20and%20%27d%27.%5Cn%5CnIn%20the%20second%20sample%20the%20expressions%20look%20as%20follows%3A%20%27%28A%29%26%28a%29%27%2C%20%27%28A%29%26%28b%29%27%2C%20%27%28A%29%26%28C%29%27%2C%20%27%28A%29%26%28D%29%27.%22%2C%22provider%22%3A%7B%22uid%22%3A3%2C%22name%22%3A%22%5Cu6d1b%5Cu8c37%22%2C%22slogan%22%3A%22%22%2C%22badge%22%3A%22%22%2C%22isAdmin%22%3Atrue%2C%22color%22%3A%22Purple%22%2C%22ccfLevel%22%3A0%7D%2C%22canEdit%22%3Afalse%2C%22limits%22%3A%7B%22time%22%3A%5B4000%5D%2C%22memory%22%3A%5B256000%5D%7D%2C%22stdCode%22%3A%22%22%2C%22vjudge%22%3A%7B%22origin%22%3A%22CodeForces%22%2C%22link%22%3A%22http%3A%5C%2F%5C%2Fcodeforces.com%5C%2Fproblemset%5C%2Fproblem%5C%2F582%5C%2FE%22%2C%22id%22%3A%22582E%22%7D%2C%22translation%22%3A%22%5Cu73b0%5Cu5728%5Cu6709%5Cu56db%5Cu4e2a%5Cu53d8%5Cu91cf%5Cuff08variable%5Cuff09%20A%2CB%2CC%2CD%5Cuff0c%5Cu8fd8%5Cu6709%5Cu4e00%5Cu4e2a%5Cu5173%5Cu4e8e%5Cu4ed6%5Cu4eec%5Cu7684%5Cu5e03%5Cu5c14%5Cu51fd%5Cu6570%5Cu3002%20A%2CB%2CC%2CD%5Cu7684%5Cu53d6%5Cu503c%5Cu662f0%5Cu6216%5Cu80051%5Cu3002%5Cu73b0%5Cu5728%5Cu5b9a%5Cu4e49%5Cu5e03%5Cu5c14%5Cu51fd%5Cu6570%5Cuff1a%5Cn%3Cexpression%3E%20%3A%3A%3D%20%3Cvariable%3E%20%7C%20%28%3Cexpression%3E%29%20%3Coperator%3E%20%28%3Cexpression%3E%29%5Cn%3Cvariable%3E%20%3A%3A%3D%20%27A%27%20%7C%20%27B%27%20%7C%20%27C%27%20%7C%20%27D%27%20%7C%20%27a%27%20%7C%20%27b%27%20%7C%20%27c%27%20%7C%20%27d%27%5Cn%3Coperator%3E%20%3A%3A%3D%20%27%26%27%20%7C%20%27%7C%27%5Cn%5Cu5927%5Cu5199%5Cu5b57%5Cu6bcdA%2CB%2CC%2CD%5Cu8868%5Cu793a%5Cu53d8%5Cu91cf%5Cuff08variable%5Cuff09%5Cuff0c%5Cu5c0f%5Cu5199%5Cu5b57%5Cu6bcd%5Cu8868%5Cu793a%5Cu4ed6%5Cu4eec%5Cu7684%5Cu53d6%5Cu53cd%5Cu3002%5Cu4f8b%5Cu5982%5Cuff0c%5Cu5982%5Cu679cA%3D1%5Cuff0c%5Cu90a3%5Cu4e48%27A%27%5Cu7684%5Cu503c%5Cu5c31%5Cu662f1%5Cuff0c%5Cu2019a%5Cu2019%5Cu7684%5Cu503c%5Cu5c31%5Cu662f0%5Cu3002%5Cu2019%26%5Cu2019%5Cu662f%5Cu903b%5Cu8f91%5Cu4e0e%5Cuff0c%5Cu2019%7C%5Cu2019%5Cu662f%5Cu903b%5Cu8f91%5Cu6216%5Cu3002%5Cn%5Cu73b0%5Cu5728%5Cu7ed9%5Cu51fa%5Cu4e00%5Cu4e2a%5Cu8868%5Cu8fbe%5Cu5f0f%5Cuff08expression%20%5Cuff09s%5Cuff0c%5Cu548c%5Cu4e00%5Cu4e9b%5Cu51fd%5Cu6570f%5Cuff0c%5Cu8fd9%5Cu91cc%5Cu9762%5Cu6709%5Cu4e00%5Cu4e9b%5Cu64cd%5Cu4f5c%5Cu7b26%5Cuff08operator%5Cuff09%5Cu548c%5Cu53d8%5Cu91cf%5Cuff08variable%5Cuff09%5Cu53ef%5Cu80fd%5Cu662f%5Cu4e22%5Cu5931%5Cu7684%5Cu3002%5Cu518d%5Cu7ed9%5Cu51faA%2CB%2CC%2CD%5Cu5728%5Cu67d0%5Cu4e9b%5Cu53d6%5Cu503c%5Cu4e0b%5Cu7684s%5Cu7684%5Cu5e03%5Cu5c14%5Cu51fd%5Cu6570%5Cu503c%20f%28A%2CB%2CC%2CD%29%5Cuff0c%5Cu8fd9%5Cu6837%5Cu7684%5Cu53d6%5Cu503c%5Cu5171%5Cu6709n%5Cu7ec4%5Cu3002%5Cn%5Cu73b0%5Cu5728%5Cu8981%5Cu8ba1%5Cu7b97%5Cu4e00%5Cu4e0b%5Cuff0c%5Cu5982%5Cu679c%5Cu7ed9%5Cu8fd9%5Cu4e9b%5Cu4e22%5Cu5931%5Cu7684%5Cu4f4d%5Cu7f6e%5Cu653e%5Cu4e0a%5Cu53d8%5Cu91cf%5Cu6216%5Cu8005%5Cu64cd%5Cu4f5c%5Cu7b26%5Cuff0c%5Cu6709%5Cu591a%5Cu5c11%5Cu79cd%5Cu7ec4%5Cu5408%5Cu80fd%5Cu6ee1%5Cu8db3%5Cu6240%5Cu6709%5Cu7684f%5Cu3002%5Cn%5Cu7b54%5Cu6848%5Cu5bf9%20109%2B7%20%5Cu53d6%5Cu4f59%5Cu8f93%5Cu51fa%5Cu3002%5Cn%5Cu6837%5Cu4f8b%5Cu89e3%5Cu91ca%5Cuff1a%5Cn%5Cu7b2c%5Cu4e00%5Cu4e2a%5Cu6837%5Cu4f8b%5Cu4e2d%5Cuff0c%5Cu628a%5Cu2019%3F%5Cu2019%5Cu6362%5Cu6210%5Cu2019C%5Cu2019%5Cu6216%5Cu8005%5Cu2019d%5Cu2019%5Cu5c31%5Cu80fd%5Cu6ee1%5Cu8db3%5Cu6761%5Cu4ef6%5Cu3002%5Cn%5Cu7b2c%5Cu4e8c%5Cu4e2a%5Cu6837%5Cu4f8b%5Cu4e2d%5Cuff0c%5Cu628a%5Cu539f%5Cu8868%5Cu8fbe%5Cu5f0f%5Cu6539%5Cu6210%20%27%28A%29%26%28a%29%27%2C%20%27%28A%29%26%28b%29%27%2C%20%27%28A%29%26%28C%29%27%2C%20%27%28A%29%26%28D%29%27%5Cuff0c%5Cu5c31%5Cu80fd%5Cu6ee1%5Cu8db3%5Cu6761%5Cu4ef6%5Cu3002%5Cn%5CnInput%5Cn%5Cu5355%5Cu7ec4%5Cu6d4b%5Cu8bd5%5Cu6570%5Cu636e%5Cu3002%5Cn%5Cu7b2c%5Cu4e00%5Cu884c%5Cu6709%5Cu4e00%5Cu4e2a%5Cu8868%5Cu8fbe%5Cu5f0f%20s%20%281%5Cu2264%7Cs%7C%5Cu2264500%29%5Cuff0c%5Cu91cc%5Cu9762%5Cu53ef%5Cu80fd%5Cu4f1a%5Cu6709%5Cu4e00%5Cu4e9b%5Cu64cd%5Cu4f5c%5Cu7b26%5Cu6216%5Cu8005%5Cu53d8%5Cu91cf%5Cu88ab%5Cu66ff%5Cu6362%5Cu6210%5Cu2019%3F%5Cu2019%5Cu3002%5Cn%5Cu7b2c%5Cu4e8c%5Cu884c%5Cu6709%5Cu4e00%5Cu4e2a%5Cu6574%5Cu6570n%20%280%5Cu2264n%5Cu226416%29%5Cuff0c%5Cu8868%5Cu793a%5Cu6709n%5Cu7ec4%5Cu7684A%2CB%2CC%2CD%5Cu5bf9%5Cu5e94%5Cu7684%5Cu51fd%5Cu6570%5Cu503cf%28A%2CB%2CC%2CD%29%5Cu5c06%5Cu4f1a%5Cu7ed9%5Cu51fa%5Cu3002%5Cn%5Cu63a5%5Cu4e0b%5Cu6765n%5Cu884c%5Cuff0c%5Cu6bcf%5Cu884c%5Cu63cf%5Cu8ff0%5Cu4e00%5Cu7ec4%5Cu51fd%5Cu6570%5Cu503c%5Cu3002%5Cu6709%5Cu4e94%5Cu4e2a%5Cu6574%5Cu6570%20ai%2Cbi%2Cci%2Cdi%2Cei%20%280%5Cu2264ai%2Cbi%2Cci%2Cdi%2Cei%5Cu22641%29%5Cuff0c%5Cu8868%5Cu793af%28ai%2Cbi%2Cci%2Cdi%29%3Dei%5Cu3002%5Cn%5Cu8f93%5Cu5165%5Cu4fdd%5Cu8bc1%28ai%2Cbi%2Cci%2Cdi%29%20%5Cu662f%5Cu4e24%5Cu4e24%5Cu4e0d%5Cu540c%5Cu7684%5Cu3002%5CnOutput%5Cn%5Cu8f93%5Cu51fa%5Cu7b54%5Cu6848%5Cu5360%5Cu4e00%5Cu884c%5Cu3002%22%2C%22tags%22%3A%5B%5D%2C%22wantsTranslation%22%3Afalse%2C%22totalSubmit%22%3A13%2C%22totalAccepted%22%3A9%2C%22pid%22%3A%22CF582E%22%2C%22title%22%3A%22Boolean%20Function%22%2C%22difficulty%22%3A7%2C%22type%22%3A%22CF%22%7D%2C%22contest%22%3Anull%2C%22discussions%22%3A%5B%7B%22id%22%3A33897%2C%22title%22%3A%22%5Cu7ffb%5Cu8bd1%22%2C%22forum%22%3A%7B%22id%22%3A10340%2C%22name%22%3A%22CF582E%20Boolean%20Function%22%2C%22slug%22%3A%22CF582E%22%7D%7D%5D%2C%22bookmarked%22%3Afalse%2C%22vjudgeUsername%22%3Anull%2C%22recommendations%22%3A%5B%5D%2C%22lastLanguage%22%3A%22%22%2C%22lastCode%22%3A%22%22%7D%2C%22currentTitle%22%3A%22Boolean%20Function%22%2C%22currentTheme%22%3Anull%7D"));window._feConfigVersion=1572920822;</script>
<script src="https://cdn.luogu.com.cn/fe/loader.js?ver=20191106" charset="utf-8" defer></script>
</head>
<body>
<div id="app">
<div class="lg-container">
<article>
<h1>Boolean Function</h1>
<h2>题意翻译</h2>
<div>现在有四个变量（variable） A,B,C,D，还有一个关于他们的布尔函数。 A,B,C,D的取值是0或者1。现在定义布尔函数：
<expression> ::= <variable> | (<expression>) <operator> (<expression>)
<variable> ::= 'A' | 'B' | 'C' | 'D' | 'a' | 'b' | 'c' | 'd'
<operator> ::= '&' | '|'
大写字母A,B,C,D表示变量（variable），小写字母表示他们的取反。例如，如果A=1，那么'A'的值就是1，’a’的值就是0。’&’是逻辑与，’|’是逻辑或。
现在给出一个表达式（expression ）s，和一些函数f，这里面有一些操作符（operator）和变量（variable）可能是丢失的。再给出A,B,C,D在某些取值下的s的布尔函数值 f(A,B,C,D)，这样的取值共有n组。
现在要计算一下，如果给这些丢失的位置放上变量或者操作符，有多少种组合能满足所有的f。
答案对 109+7 取余输出。
样例解释：
第一个样例中，把’?’换成’C’或者’d’就能满足条件。
第二个样例中，把原表达式改成 '(A)&(a)', '(A)&(b)', '(A)&(C)', '(A)&(D)'，就能满足条件。
Input
单组测试数据。
第一行有一个表达式 s (1≤|s|≤500)，里面可能会有一些操作符或者变量被替换成’?’。
第二行有一个整数n (0≤n≤16)，表示有n组的A,B,C,D对应的函数值f(A,B,C,D)将会给出。
接下来n行，每行描述一组函数值。有五个整数 ai,bi,ci,di,ei (0≤ai,bi,ci,di,ei≤1)，表示f(ai,bi,ci,di)=ei。
输入保证(ai,bi,ci,di) 是两两不同的。
Output
输出答案占一行。</div>
<h2>题目描述</h2>
<div>In this problem we consider Boolean functions of four variables $ A,B,C,D $ . Variables $ A,B,C $ and $ D $ are logical and can take values 0 or 1. We will define a function using the following grammar:
<expression> ::= <variable> | (<expression>) <operator> (<expression>)
<variable> ::= 'A' | 'B' | 'C' | 'D' | 'a' | 'b' | 'c' | 'd'
<operator> ::= '&' | '|'
Here large letters $ A,B,C,D $ represent variables, and small letters represent their negations. For example, if $ A=1 $ , then character 'A' corresponds to value 1, and value character 'a' corresponds to value 0. Here character '&' corresponds to the operation of logical AND, character '|' corresponds to the operation of logical OR.
You are given expression $ s $ , defining function $ f $ , where some operations and variables are missing. Also you know the values of the function $ f(A,B,C,D) $ for some $ n $ distinct sets of variable values. Count the number of ways to restore the elements that are missing in the expression so that the resulting expression corresponded to the given information about function $ f $ in the given variable sets. As the value of the result can be rather large, print its remainder modulo $ 10^{9}+7 $ .</div>
<h2>输入输出格式</h2>
<h3>输入格式</h3>
<br />
<div>The first line contains expression $ s $ ( $ 1<=|s|<=500 $ ), where some characters of the operators and/or variables are replaced by character '?'.
The second line contains number $ n $ ( $ 0<=n<=2^{4} $ ) — the number of integers sets for which we know the value of function $ f(A,B,C,D) $ . Next $ n $ lines contain the descriptions of the sets: the $ i $ -th of them contains five integers $ a_{i},b_{i},c_{i},d_{i},e_{i} $ ( $ 0<=a_{i},b_{i},c_{i},d_{i},e_{i}<=1 $ ), separated by spaces and meaning that $ f(a_{i},b_{i},c_{i},d_{i})=e_{i} $ .
It is guaranteed that all the tuples ( $ a_{i},b_{i},c_{i},d_{i} $ ) are distinct.</div>
<h3>输出格式</h3>
<br />
<div>In a single line print the answer to the problem.</div>
<h2>输入输出样例</h2>
<h3>输入样例 #1</h3>
<pre><code>?
2
1 0 1 0 1
0 1 1 0 1
</code></pre>
<h3>输出样例 #1</h3>
<pre><code>2
</code></pre>
<h3>输入样例 #2</h3>
<pre><code>(A)?(?)
1
1 1 0 0 0
</code></pre>
<h3>输出样例 #2</h3>
<pre><code>4
</code></pre>
<h3>输入样例 #3</h3>
<pre><code>((?)&amp;(?))|((?)&amp;(?))
0
</code></pre>
<h3>输出样例 #3</h3>
<pre><code>4096</code></pre>
<h3>输入样例 #4</h3>
<pre><code>b
1
1 0 1 1 1
</code></pre>
<h3>输出样例 #4</h3>
<pre><code>1
</code></pre>
<h2>说明</h2>
<div>In the first sample the two valid expressions are 'C' and 'd'.
In the second sample the expressions look as follows: '(A)&(a)', '(A)&(b)', '(A)&(C)', '(A)&(D)'.</div>
</article>
</div>
</div>
</body>
</html>
