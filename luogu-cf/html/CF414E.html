<!DOCTYPE html>
<html class="no-js" lang="zh">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Mashmokh&#039;s Designed Problem - 洛谷</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="renderer" content="webkit">
<meta name="csrf-token" content="1573393861:QXgypUi0P7Kjq2+spbKR9ItaEJ8W2qBaM3I6qEyA4rQ=">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" media="screen"/>
<link rel="stylesheet" href="https://cdn.luogu.com.cn/fe/loader.css?ver=20191106">
<script>window._feInjection = JSON.parse(decodeURIComponent("%7B%22code%22%3A200%2C%22currentTemplate%22%3A%22ProblemShow%22%2C%22currentData%22%3A%7B%22problem%22%3A%7B%22background%22%3Anull%2C%22description%22%3A%22After%20a%20lot%20of%20trying%2C%20Mashmokh%20designed%20a%20problem%20and%20it%27s%20your%20job%20to%20solve%20it.%5Cn%5CnYou%20have%20a%20tree%20%24%20T%20%24%20with%20%24%20n%20%24%20vertices.%20Each%20vertex%20has%20a%20unique%20index%20from%201%20to%20%24%20n%20%24%20.%20The%20root%20of%20%24%20T%20%24%20has%20index%20%24%201%20%24%20.%20For%20each%20vertex%20of%20this%20tree%20%24%20v%20%24%20%2C%20you%20are%20given%20a%20list%20of%20its%20children%20in%20a%20specific%20order.%20You%20must%20perform%20three%20types%20of%20query%20on%20this%20tree%3A%5Cn%5Cn1.%20find%20distance%20%28the%20number%20of%20edges%20in%20the%20shortest%20path%29%20between%20%24%20u%20%24%20and%20%24%20v%20%24%20%3B%5Cn2.%20given%20%24%20v%20%24%20and%20%24%20h%20%24%20%2C%20disconnect%20%24%20v%20%24%20from%20its%20father%20and%20connect%20it%20to%20its%20%24%20h%20%24%20-th%20ancestor%3B%20more%20formally%2C%20let%27s%20denote%20the%20path%20from%20%24%20v%20%24%20to%20the%20root%20by%20%24%20x_%7B1%7D%2Cx_%7B2%7D%2C...%2Cx_%7Bl%7D%5Cu00a0%28h%26lt%3Bl%29%20%24%20%2C%20so%20that%20%24%20x_%7B1%7D%3Dv%20%24%20and%20%24%20x_%7Bl%7D%20%24%20is%20root%3B%20disconnect%20%24%20v%20%24%20from%20its%20father%20%28%20%24%20x_%7B2%7D%20%24%20%29%20and%20connect%20it%20to%20%24%20x_%7Bh%2B1%7D%20%24%20%3B%20vertex%20%24%20v%20%24%20must%20be%20added%20to%20the%20end%20of%20the%20child-list%20of%20vertex%20%24%20x_%7Bh%2B1%7D%20%24%20%3B%5Cn3.%20in%20the%20vertex%20sequence%20produced%20by%20calling%20function%20dfs%28root%29%20find%20the%20latest%20vertex%20that%20has%20distance%20%24%20k%20%24%20from%20the%20root.%5Cn%5CnThe%20pseudo-code%20of%20function%20dfs%28v%29%3A%5Cn%5Cn%60%3Cbr%3E%3C%5C%2Fbr%3E%5C%2F%5C%2F%20ls%5Bv%5D%3A%20list%20of%20children%20of%20vertex%20v%20%3Cbr%3E%3C%5C%2Fbr%3E%5C%2F%5C%2F%20its%20i-th%20element%20is%20ls%5Bv%5D%5Bi%5D%3Cbr%3E%3C%5C%2Fbr%3E%5C%2F%5C%2F%20its%20size%20is%20size%28ls%5Bv%5D%29%3Cbr%3E%3C%5C%2Fbr%3Esequence%20result%20%3D%20empty%20sequence%3B%3Cbr%3E%3C%5C%2Fbr%3Evoid%20dfs%28vertex%20now%29%3Cbr%3E%3C%5C%2Fbr%3E%7B%3Cbr%3E%3C%5C%2Fbr%3E%20%20%20%20add%20now%20to%20end%20of%20result%3B%3Cbr%3E%3C%5C%2Fbr%3E%20%20%20%20for%28int%20i%20%3D%201%3B%20i%20%3C%3D%20size%28ls%5Bv%5D%29%3B%20i%20%3D%20i%20%2B%201%29%20%5C%2F%5C%2Floop%20from%20i%20%3D%201%20to%20i%20%3D%20size%28ls%5Bv%5D%29%3Cbr%3E%3C%5C%2Fbr%3E%20%20%20%20%20%20%20%20dfs%28ls%5Bv%5D%5Bi%5D%29%3B%3Cbr%3E%3C%5C%2Fbr%3E%7D%3Cbr%3E%3C%5C%2Fbr%3E%60%22%2C%22inputFormat%22%3A%22The%20first%20line%20of%20input%20contains%20two%20space-separated%20integers%20%24%20n%2Cm%5Cu00a0%282%3C%3Dn%3C%3D10%5E%7B5%7D%3B%5Cu00a01%3C%3Dm%3C%3D10%5E%7B5%7D%29%20%24%20%2C%20the%20number%20of%20vertices%20of%20%24%20T%20%24%20and%20number%20of%20queries%20to%20perform.%5Cn%5CnThe%20%24%20i%20%24%20-th%20of%20the%20following%20%24%20n%20%24%20lines%20contains%20an%20integer%20%24%20l_%7Bi%7D%5Cu00a0%280%3C%3Dl_%7Bi%7D%3C%3Dn%29%20%24%20%2C%20number%20of%20%24%20i%20%24%20-th%20vertex%27s%20children.%20Then%20%24%20l_%7Bi%7D%20%24%20space-separated%20integers%20follow%2C%20the%20%24%20j%20%24%20-th%20of%20them%20is%20the%20index%20of%20%24%20j%20%24%20-th%20child%20of%20%24%20i%20%24%20-th%20vertex.%20Note%20that%20the%20order%20of%20these%20vertices%20is%20important.%5Cn%5CnEach%20of%20the%20following%20%24%20m%20%24%20lines%20has%20one%20of%20the%20following%20format%3A%20%5C%22%20%24%201%20%24%20%24%20v%20%24%20%24%20u%20%24%20%5C%22%2C%20%5C%22%20%24%202%20%24%20%24%20v%20%24%20%24%20h%20%24%20%5C%22%2C%20or%20%5C%22%20%24%203%20%24%20%24%20k%20%24%20%5C%22.%20The%20first%20number%20in%20the%20line%20is%20the%20type%20of%20query%20to%20perform%20according%20to%20the%20problem%20statement.%20The%20next%20numbers%20are%20description%20of%20the%20query.%5Cn%5CnIt%27s%20guaranteed%20that%20all%20the%20queries%20are%20correct.%20For%20example%2C%20in%20the%20second-type%20query%20%24%20h%20%24%20is%20at%20least%202%20and%20at%20most%20distance%20of%20%24%20v%20%24%20from%20root.%20Also%20in%20the%20third-type%20query%20there%20is%20at%20least%20one%20vertex%20with%20distance%20%24%20k%20%24%20from%20the%20root%20at%20the%20time%20the%20query%20is%20given.%22%2C%22outputFormat%22%3A%22For%20each%20query%20of%20the%20first%20or%20third%20type%20output%20one%20line%20containing%20the%20result%20of%20the%20query.%22%2C%22samples%22%3A%5B%5B%224%209%5Cn1%202%5Cn1%203%5Cn1%204%5Cn0%5Cn1%201%204%5Cn2%204%202%5Cn1%203%204%5Cn3%201%5Cn3%202%5Cn2%203%202%5Cn1%201%202%5Cn3%201%5Cn3%202%5Cn%22%2C%223%5Cn2%5Cn2%5Cn4%5Cn1%5Cn3%5Cn4%5Cn%22%5D%2C%5B%222%202%5Cn1%202%5Cn0%5Cn1%202%201%5Cn3%201%5Cn%22%2C%221%5Cn2%5Cn%22%5D%5D%2C%22hint%22%3A%22%22%2C%22provider%22%3A%7B%22uid%22%3A3%2C%22name%22%3A%22%5Cu6d1b%5Cu8c37%22%2C%22slogan%22%3A%22%22%2C%22badge%22%3A%22%22%2C%22isAdmin%22%3Atrue%2C%22color%22%3A%22Purple%22%2C%22ccfLevel%22%3A0%7D%2C%22canEdit%22%3Afalse%2C%22limits%22%3A%7B%22time%22%3A%5B4000%5D%2C%22memory%22%3A%5B512000%5D%7D%2C%22stdCode%22%3A%22%22%2C%22vjudge%22%3A%7B%22origin%22%3A%22CodeForces%22%2C%22link%22%3A%22http%3A%5C%2F%5C%2Fcodeforces.com%5C%2Fproblemset%5C%2Fproblem%5C%2F414%5C%2FE%22%2C%22id%22%3A%22414E%22%7D%2C%22translation%22%3A%22%5Cu7ed9%5Cu5b9a%5Cu4e00%5Cu68f5%24n%24%5Cu4e2a%5Cu8282%5Cu70b9%5Cu7684%5Cu6709%5Cu6839%5Cu6811%5Cuff0c%5Cu6bcf%5Cu4e2a%5Cu70b9%5Cu8fde%5Cu51fa%5Cu7684%5Cu8fb9%5Cu90fd%5Cu6709%5Cu5e8f%5Cuff0c%5Cu5171%5Cu6709m%5Cu4e2a%5Cu64cd%5Cu4f5c%5Cu3002%5Cuff08n%20%3C%3D%2010%5E5%2Cm%20%3C%3D%2010%5E5%5Cuff09%5Cr%5Cn%5Cr%5Cn%5Cu64cd%5Cu4f5c%5Cu6709%5Cuff1a%5Cr%5Cn%5Cr%5Cn-%201.%5Cu67e5%5Cu8be2%5Cu4e24%5Cu4e2a%5Cu70b9u%2Cv%5Cu7684%5Cu8ddd%5Cu79bb%5Cr%5Cn-%202.%5Cu4ee5%24v%24%5Cu4e3a%5Cu6839%5Cu7684%5Cu5b50%5Cu6811%5Cu4ece%5Cu6811%5Cu4e2d%5Cu5206%5Cu5f00%5Cuff0c%5Cu5e76%5Cu6dfb%5Cu52a0%5Cu4e00%5Cu6761%5Cu4e0e%5Cu5176%5Cu7b2c%24h%24%5Cu4e2a%5Cu7956%5Cu5148%5Cu7684%5Cu8fde%5Cu8fb9%5Cu4f5c%5Cu4e3a%5Cu8be5%5Cu7956%5Cu5148%5Cu7684%5Cu6700%5Cu540e%5Cu4e00%5Cu4e2a%5Cu513f%5Cu5b50%5Cu3002%5Cr%5Cn-%203.%5Cu67e5%5Cu8be2%5Cu4ece%5Cu4e00%5Cu4e2a%5Cu70b9%5Cu51fa%5Cu53d1%5Cuff0c%5Cu6309%5Cu8fb9%5Cu7684%5Cu987a%5Cu5e8f%5Cu8fdb%5Cu884cdfs%2C%5Cu6df1%5Cu5ea6%5Cu4e3a%24k%24%5Cu7684%5Cu6700%5Cu540e%5Cu904d%5Cu5386%5Cu7684%5Cu70b9%5Cr%5Cn%5Cr%5Cn%2A%2A%5Cu8f93%5Cu5165%5Cu683c%5Cu5f0f%5Cuff1a%2A%2A%5Cr%5Cn%5Cr%5Cn%5Cu7b2c%5Cu4e00%5Cu884c%5Cu4e24%5Cu4e2a%5Cu6574%5Cu6570n%5Cu548cm%5Cr%5Cn%5Cr%5Cn%5Cu4e0b%5Cu9762%24n%24%5Cu884c%5Cu5305%5Cu542b%5Cu4e00%5Cu4e2a%5Cu6574%5Cu6570%24l_i%24%5Cuff08%240%24%20%3C%3D%20%24l_i%24%20%3C%3D%20%24n%24%5Cuff09%5Cuff0c%5Cu63cf%5Cu8ff0%5Cu4e86%5Cu7b2c%24i%24%5Cu4e2a%5Cu6570%5Cu7684%5Cu7b2c%24j%24%5Cu4e2a%5Cu513f%5Cu5b50%5Cuff0c%5Cu6ce8%5Cu610f%5Cu8fd9%5Cu4e9b%5Cu9876%5Cu70b9%5Cu7684%5Cu987a%5Cu5e8f%5Cu3002%5Cr%5Cn%5Cr%5Cn%5Cu63a5%5Cu4e0b%5Cu6765%24m%24%5Cu884c%5Cuff0c%5Cu6bcf%5Cu884c%5Cu5982%20%5Cu201c%24%5C%5Ctext%7B1%20v%20u%7D%24%5Cu201d%5Cuff0c%5Cu201c%24%5C%5Ctext%7B2%20v%20h%7D%24%5Cu201d%5Cuff0c%5Cu6216%5Cu201c%24%5C%5Ctext%7B3%20k%7D%24%5Cu201d%5Cu3002%5Cr%5Cn%5Cr%5Cn%2A%2A%5Cu8f93%5Cu51fa%5Cu683c%5Cu5f0f%5Cuff1a%2A%2A%5Cr%5Cn%5Cr%5Cn%5Cu5bf9%5Cu4e8e%5Cu6bcf%5Cu4e2a1%5Cu548c3%5Cu64cd%5Cu4f5c%5Cu8f93%5Cu51fa%5Cu4e00%5Cu884c%5Cu5bf9%5Cu5e94%5Cu8be2%5Cu95ee%5Cu7684%5Cu7ed3%5Cu679c%5Cr%5Cn%5Cr%5Cn%22%2C%22tags%22%3A%5B%5D%2C%22wantsTranslation%22%3Afalse%2C%22totalSubmit%22%3A8%2C%22totalAccepted%22%3A5%2C%22pid%22%3A%22CF414E%22%2C%22title%22%3A%22Mashmokh%27s%20Designed%20Problem%22%2C%22difficulty%22%3A0%2C%22type%22%3A%22CF%22%7D%2C%22contest%22%3Anull%2C%22discussions%22%3A%5B%5D%2C%22bookmarked%22%3Afalse%2C%22vjudgeUsername%22%3Anull%2C%22recommendations%22%3A%5B%5D%2C%22lastLanguage%22%3A%22%22%2C%22lastCode%22%3A%22%22%7D%2C%22currentTitle%22%3A%22Mashmokh%27s%20Designed%20Problem%22%2C%22currentTheme%22%3Anull%7D"));window._feConfigVersion=1572920822;</script>
<script src="https://cdn.luogu.com.cn/fe/loader.js?ver=20191106" charset="utf-8" defer></script>
</head>
<body>
<div id="app">
<div class="lg-container">
<article>
<h1>Mashmokh&#039;s Designed Problem</h1>
<h2>题意翻译</h2>
<div>给定一棵$n$个节点的有根树，每个点连出的边都有序，共有m个操作。（n <= 10^5,m <= 10^5）
操作有：
- 1.查询两个点u,v的距离
- 2.以$v$为根的子树从树中分开，并添加一条与其第$h$个祖先的连边作为该祖先的最后一个儿子。
- 3.查询从一个点出发，按边的顺序进行dfs,深度为$k$的最后遍历的点
**输入格式：**
第一行两个整数n和m
下面$n$行包含一个整数$l_i$（$0$ <= $l_i$ <= $n$），描述了第$i$个数的第$j$个儿子，注意这些顶点的顺序。
接下来$m$行，每行如 “$\text{1 v u}$”，“$\text{2 v h}$”，或“$\text{3 k}$”。
**输出格式：**
对于每个1和3操作输出一行对应询问的结果
</div>
<h2>题目描述</h2>
<div>After a lot of trying, Mashmokh designed a problem and it's your job to solve it.
You have a tree $ T $ with $ n $ vertices. Each vertex has a unique index from 1 to $ n $ . The root of $ T $ has index $ 1 $ . For each vertex of this tree $ v $ , you are given a list of its children in a specific order. You must perform three types of query on this tree:
1. find distance (the number of edges in the shortest path) between $ u $ and $ v $ ;
2. given $ v $ and $ h $ , disconnect $ v $ from its father and connect it to its $ h $ -th ancestor; more formally, let's denote the path from $ v $ to the root by $ x_{1},x_{2},...,x_{l} (h&lt;l) $ , so that $ x_{1}=v $ and $ x_{l} $ is root; disconnect $ v $ from its father ( $ x_{2} $ ) and connect it to $ x_{h+1} $ ; vertex $ v $ must be added to the end of the child-list of vertex $ x_{h+1} $ ;
3. in the vertex sequence produced by calling function dfs(root) find the latest vertex that has distance $ k $ from the root.
The pseudo-code of function dfs(v):
`<br></br>// ls[v]: list of children of vertex v <br></br>// its i-th element is ls[v][i]<br></br>// its size is size(ls[v])<br></br>sequence result = empty sequence;<br></br>void dfs(vertex now)<br></br>{<br></br> add now to end of result;<br></br> for(int i = 1; i <= size(ls[v]); i = i + 1) //loop from i = 1 to i = size(ls[v])<br></br> dfs(ls[v][i]);<br></br>}<br></br>`</div>
<h2>输入输出格式</h2>
<h3>输入格式</h3>
<br />
<div>The first line of input contains two space-separated integers $ n,m (2<=n<=10^{5}; 1<=m<=10^{5}) $ , the number of vertices of $ T $ and number of queries to perform.
The $ i $ -th of the following $ n $ lines contains an integer $ l_{i} (0<=l_{i}<=n) $ , number of $ i $ -th vertex's children. Then $ l_{i} $ space-separated integers follow, the $ j $ -th of them is the index of $ j $ -th child of $ i $ -th vertex. Note that the order of these vertices is important.
Each of the following $ m $ lines has one of the following format: " $ 1 $ $ v $ $ u $ ", " $ 2 $ $ v $ $ h $ ", or " $ 3 $ $ k $ ". The first number in the line is the type of query to perform according to the problem statement. The next numbers are description of the query.
It's guaranteed that all the queries are correct. For example, in the second-type query $ h $ is at least 2 and at most distance of $ v $ from root. Also in the third-type query there is at least one vertex with distance $ k $ from the root at the time the query is given.</div>
<h3>输出格式</h3>
<br />
<div>For each query of the first or third type output one line containing the result of the query.</div>
<h2>输入输出样例</h2>
<h3>输入样例 #1</h3>
<pre><code>4 9
1 2
1 3
1 4
0
1 1 4
2 4 2
1 3 4
3 1
3 2
2 3 2
1 1 2
3 1
3 2
</code></pre>
<h3>输出样例 #1</h3>
<pre><code>3
2
2
4
1
3
4
</code></pre>
<h3>输入样例 #2</h3>
<pre><code>2 2
1 2
0
1 2 1
3 1
</code></pre>
<h3>输出样例 #2</h3>
<pre><code>1
2
</code></pre>
</article>
</div>
</div>
</body>
</html>
