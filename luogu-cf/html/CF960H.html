<!DOCTYPE html>
<html class="no-js" lang="zh">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Santa&#039;s Gift - 洛谷</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="renderer" content="webkit">
<meta name="csrf-token" content="1573399833:wIlhGQ+lejF2rOyp14fUjS2EnXlTxitQIc3h4HBMUk4=">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" media="screen"/>
<link rel="stylesheet" href="https://cdn.luogu.com.cn/fe/loader.css?ver=20191106">
<script>window._feInjection = JSON.parse(decodeURIComponent("%7B%22code%22%3A200%2C%22currentTemplate%22%3A%22ProblemShow%22%2C%22currentData%22%3A%7B%22problem%22%3A%7B%22background%22%3Anull%2C%22description%22%3A%22Santa%20has%20an%20infinite%20number%20of%20candies%20for%20each%20of%20%24%20m%20%24%20flavours.%20You%20are%20given%20a%20rooted%20tree%20with%20%24%20n%20%24%20vertices.%20The%20root%20of%20the%20tree%20is%20the%20vertex%20%24%201%20%24%20.%20Each%20vertex%20contains%20exactly%20one%20candy.%20The%20%24%20i%20%24%20-th%20vertex%20has%20a%20candy%20of%20flavour%20%24%20f_i%20%24%20.%5Cn%5CnSometimes%20Santa%20fears%20that%20candies%20of%20flavour%20%24%20k%20%24%20have%20melted.%20He%20chooses%20any%20vertex%20%24%20x%20%24%20randomly%20and%20sends%20the%20subtree%20of%20%24%20x%20%24%20to%20the%20Bakers%20for%20a%20replacement.%20In%20a%20replacement%2C%20all%20the%20candies%20with%20flavour%20%24%20k%20%24%20are%20replaced%20with%20a%20new%20candy%20of%20the%20same%20flavour.%20The%20candies%20which%20are%20not%20of%20flavour%20%24%20k%20%24%20are%20left%20unchanged.%20After%20the%20replacement%2C%20the%20tree%20is%20restored.%5Cn%5CnThe%20actual%20cost%20of%20replacing%20one%20candy%20of%20flavour%20%24%20k%20%24%20is%20%24%20c_k%20%24%20%28given%20for%20each%20%24%20k%20%24%20%29.%20The%20Baker%20keeps%20the%20price%20fixed%20in%20order%20to%20make%20calculation%20simple.%20Every%20time%20when%20a%20subtree%20comes%20for%20a%20replacement%2C%20the%20Baker%20charges%20%24%20C%20%24%20%2C%20no%20matter%20which%20subtree%20it%20is%20and%20which%20flavour%20it%20is.%5Cn%5CnSuppose%20that%20for%20a%20given%20flavour%20%24%20k%20%24%20the%20probability%20that%20Santa%20chooses%20a%20vertex%20for%20replacement%20is%20same%20for%20all%20the%20vertices.%20You%20need%20to%20find%20out%20the%20expected%20value%20of%20error%20in%20calculating%20the%20cost%20of%20replacement%20of%20flavour%20%24%20k%20%24%20.%20The%20error%20in%20calculating%20the%20cost%20is%20defined%20as%20follows.%5Cn%5Cn%20%24%20%24%24%24%20Error%5C%5C%20E%28k%29%20%3D%5C%5C%20%28Actual%20Cost%5C%5C%20%5Cu2013%5C%5C%20Price%5C%5C%20charged%5C%5C%20by%5C%5C%20the%5C%5C%20Bakers%29%20%5E%202.%20%24%20%24%20%3C%5C%2Fp%3E%3Cp%3ENote%20that%20the%20actual%20cost%20is%20the%20cost%20of%20replacement%20of%20one%20candy%20of%20the%20flavour%20%20%24%20k%20%24%20%20multiplied%20by%20the%20number%20of%20candies%20in%20the%20subtree.%3C%5C%2Fp%3E%3Cp%3EAlso%2C%20sometimes%20Santa%20may%20wish%20to%20replace%20a%20candy%20at%20vertex%20%20%24%20x%20%24%20%20with%20a%20candy%20of%20some%20flavour%20from%20his%20pocket.%3C%5C%2Fp%3E%3Cp%3EYou%20need%20to%20handle%20two%20types%20of%20operations%3A%20%3C%5C%2Fp%3E%3Cul%3E%20%3Cli%3E%20Change%20the%20flavour%20of%20the%20candy%20at%20vertex%20%20%24%20x%20%24%20%20to%20%20%24%20w%20%24%20.%20%3C%5C%2Fli%3E%3Cli%3E%20Calculate%20the%20expected%20value%20of%20error%20in%20calculating%20the%20cost%20of%20replacement%20for%20a%20given%20flavour%20%20%24%20k%24%24%24.%22%2C%22inputFormat%22%3A%22The%20first%20line%20of%20the%20input%20contains%20four%20integers%20%24%20n%20%24%20%28%20%24%202%5Cu2009%5C%5Cleqslant%5Cu2009n%5Cu2009%5C%5Cleqslant%5Cu20095%20%5C%5Ccdot%2010%5E4%20%24%20%29%2C%20%24%20m%20%24%20%2C%20%24%20q%20%24%20%2C%20%24%20C%20%24%20%28%20%24%201%5Cu2009%5C%5Cleqslant%5Cu2009m%2C%20q%5Cu2009%5C%5Cleqslant%5Cu20095%20%5C%5Ccdot%2010%5E4%20%24%20%2C%20%24%200%20%5C%5Cleqslant%20C%20%5C%5Cleqslant%2010%5E6%20%24%20%29%20%5Cu2014%20the%20number%20of%20nodes%2C%20total%20number%20of%20different%20flavours%20of%20candies%2C%20the%20number%20of%20queries%20and%20the%20price%20charged%20by%20the%20Bakers%20for%20replacement%2C%20respectively.%5Cn%5CnThe%20second%20line%20contains%20%24%20n%20%24%20integers%20%24%20f_1%2C%20f_2%2C%20%5C%5Cdots%2C%20f_n%20%24%20%28%20%24%201%20%5C%5Cleqslant%20f_i%20%5C%5Cleqslant%20m%20%24%20%29%2C%20where%20%24%20f_i%20%24%20is%20the%20initial%20flavour%20of%20the%20candy%20in%20the%20%24%20i%20%24%20-th%20node.%5Cn%5CnThe%20third%20line%20contains%20%24%20n%20-%201%20%24%20integers%20%24%20p_2%2C%20p_3%2C%20%5C%5Cdots%2C%20p_n%20%24%20%28%20%24%201%20%5C%5Cleqslant%20p_i%20%5C%5Cleqslant%20n%20%24%20%29%2C%20where%20%24%20p_i%20%24%20is%20the%20parent%20of%20the%20%24%20i%20%24%20-th%20node.%5Cn%5CnThe%20next%20line%20contains%20%24%20m%20%24%20integers%20%24%20c_1%2C%20c_2%2C%20%5C%5Cdots%20c_m%20%24%20%28%20%24%201%20%5C%5Cleqslant%20c_i%20%5C%5Cleqslant%2010%5E2%20%24%20%29%2C%20where%20%24%20c_i%20%24%20is%20the%20cost%20of%20replacing%20one%20candy%20of%20flavour%20%24%20i%20%24%20.%5Cn%5CnThe%20next%20%24%20q%20%24%20lines%20describe%20the%20queries.%20Each%20line%20starts%20with%20an%20integer%20%24%20t%20%24%20%28%20%24%201%5Cu2009%5C%5Cleqslant%5Cu2009t%5Cu2009%5C%5Cleqslant%5Cu20092%20%24%20%29%20%5Cu2014%20the%20type%20of%20the%20query.%5Cn%5CnIf%20%24%20t%5Cu2009%3D%5Cu20091%20%24%20%2C%20then%20the%20line%20describes%20a%20query%20of%20the%20first%20type.%20Two%20integers%20%24%20x%20%24%20and%20%24%20w%20%24%20follow%20%28%20%24%201%5Cu2009%5C%5Cleqslant%20%5Cu2009x%20%5C%5Cleqslant%20%5Cu2009n%20%24%20%2C%20%24%201%20%5C%5Cleqslant%20%5Cu2009w%20%5C%5Cleqslant%5Cu2009m%20%24%20%29%2C%20it%20means%20that%20Santa%20replaces%20the%20candy%20at%20vertex%20%24%20x%20%24%20with%20flavour%20%24%20w%20%24%20.%5Cn%5CnOtherwise%2C%20if%20%24%20t%20%3D%202%20%24%20%2C%20the%20line%20describes%20a%20query%20of%20the%20second%20type%20and%20an%20integer%20%24%20k%20%24%20%28%20%24%201%5Cu2009%5C%5Cleqslant%5Cu2009k%5Cu2009%5C%5Cleqslant%5Cu2009m%20%24%20%29%20follows%2C%20it%20means%20that%20you%20should%20print%20the%20expected%20value%20of%20the%20error%20in%20calculating%20the%20cost%20of%20replacement%20for%20a%20given%20flavour%20%24%20k%20%24%20.%5Cn%5CnThe%20vertices%20are%20indexed%20from%20%24%201%20%24%20to%20%24%20n%20%24%20.%20Vertex%20%24%201%20%24%20is%20the%20root.%22%2C%22outputFormat%22%3A%22Output%20the%20answer%20to%20each%20query%20of%20the%20second%20type%20in%20a%20separate%20line.%5Cn%5CnYour%20answer%20is%20considered%20correct%20if%20its%20absolute%20or%20relative%20error%20does%20not%20exceed%20%24%2010%5E%7B-6%7D%20%24%20.%5Cn%5CnFormally%2C%20let%20your%20answer%20be%20%24%20a%20%24%20%2C%20and%20the%20jury%27s%20answer%20be%20%24%20b%20%24%20.%20The%20checker%20program%20considers%20your%20answer%20correct%20if%20and%20only%20if%20%24%20%5C%5Cfrac%7B%7Ca-b%7C%7D%7Bmax%281%2Cb%29%7D%5C%5Cleqslant%2010%5E%7B-6%7D%20%24%20.%22%2C%22samples%22%3A%5B%5B%223%205%205%207%5Cn3%201%204%5Cn1%201%5Cn73%201%2048%2085%2089%5Cn2%201%5Cn2%203%5Cn1%202%203%5Cn2%201%5Cn2%203%5Cn%22%2C%222920.333333333333%5Cn593.000000000000%5Cn49.000000000000%5Cn3217.000000000000%5Cn%22%5D%5D%2C%22hint%22%3A%22For%20%24%201%20%24%20-st%20query%2C%20the%20error%20in%20calculating%20the%20cost%20of%20replacement%20for%20flavour%20%24%201%20%24%20if%20vertex%20%24%201%20%24%20%2C%20%24%202%20%24%20or%20%24%203%20%24%20is%20chosen%20are%20%24%2066%5E2%20%24%20%2C%20%24%2066%5E2%20%24%20and%20%24%20%28-7%29%5E2%20%24%20respectively.%20Since%20the%20probability%20of%20choosing%20any%20vertex%20is%20same%2C%20therefore%20the%20expected%20value%20of%20error%20is%20%24%20%5C%5Cfrac%7B66%5E2%2B66%5E2%2B%28-7%29%5E2%7D%7B3%7D%20%24%20.%5Cn%5CnSimilarly%2C%20for%20%24%202%20%24%20-nd%20query%20the%20expected%20value%20of%20error%20is%20%24%20%5C%5Cfrac%7B41%5E2%2B%28-7%29%5E2%2B%28-7%29%5E2%7D%7B3%7D%20%24%20.%5Cn%5CnAfter%20%24%203%20%24%20-rd%20query%2C%20the%20flavour%20at%20vertex%20%24%202%20%24%20changes%20from%20%24%201%20%24%20to%20%24%203%20%24%20.%5Cn%5CnFor%20%24%204%20%24%20-th%20query%2C%20the%20expected%20value%20of%20error%20is%20%24%20%5C%5Cfrac%7B%28-7%29%5E2%2B%28-7%29%5E2%2B%28-7%29%5E2%7D%7B3%7D%20%24%20.%5Cn%5CnSimilarly%2C%20for%20%24%205%20%24%20-th%20query%2C%20the%20expected%20value%20of%20error%20is%20%24%20%5C%5Cfrac%7B89%5E2%2B41%5E2%2B%28-7%29%5E2%7D%7B3%7D%20%24%20.%22%2C%22provider%22%3A%7B%22uid%22%3A3%2C%22name%22%3A%22%5Cu6d1b%5Cu8c37%22%2C%22slogan%22%3A%22%22%2C%22badge%22%3A%22%22%2C%22isAdmin%22%3Atrue%2C%22color%22%3A%22Purple%22%2C%22ccfLevel%22%3A0%7D%2C%22canEdit%22%3Afalse%2C%22limits%22%3A%7B%22time%22%3A%5B4000%5D%2C%22memory%22%3A%5B512000%5D%7D%2C%22stdCode%22%3A%22%22%2C%22vjudge%22%3A%7B%22origin%22%3A%22CodeForces%22%2C%22link%22%3A%22http%3A%5C%2F%5C%2Fcodeforces.com%5C%2Fproblemset%5C%2Fproblem%5C%2F960%5C%2FH%22%2C%22id%22%3A%22960H%22%7D%2C%22translation%22%3A%22%5Cu7ed9%5Cu4e00%5Cu68f5%24n%24%5Cu4e2a%5Cu70b9%5Cu7684%5Cu6709%5Cu6839%5Cu6811%5Cuff0c%5Cu6bcf%5Cu4e2a%5Cu70b9%5Cu6709%5Cu4e00%5Cu4e2a%5Cu989c%5Cu8272%24a_i%24%5Cuff0c%5Cu5bf9%5Cu4e8e%5Cu6bcf%5Cu79cd%5Cu989c%5Cu8272%5Cu6709%5Cu4e00%5Cu4e2a%5Cu6743%5Cu503c%24b_i%24%5Cu3002%5Cu518d%5Cu7ed9%5Cu4f60%5Cu4e00%5Cu4e2a%5Cu5e38%5Cu6570%24C%24%5Cu3002%5Cr%5Cn%5Cr%5Cn%5Cu5171%5Cu8fdb%5Cu884c%24Q%24%5Cu6b21%5Cu64cd%5Cu4f5c%5Cuff0c%5Cu64cd%5Cu4f5c%5Cu5206%5Cu4e3a%5Cu4e24%5Cu79cd%5Cuff1a%5Cr%5Cn%5Cr%5Cn-%20%60%60%601%20x%20y%60%60%60%5Cu628a%5Cu8282%5Cu70b9x%5Cu7684%5Cu989c%5Cu8272%5Cu4fee%5Cu6539%5Cu4e3ay%5Cr%5Cn%5Cr%5Cn-%20%60%60%602%20x%60%60%60%5Cu5bf9%5Cu989c%5Cu8272x%5Cu8fdb%5Cu884c%5Cu8be2%5Cu95ee%5Cu3002%5Cu6c42%24%5C%5Cfrac%7B%5C%5Csum_%7Bi%3D1%7D%5En%28S_i%5C%5Ctimes%20b_x-C%29%5E2%7D%7Bn%7D%24%5Cuff0c%5Cu5176%5Cu4e2d%24S_i%24%5Cu662f%24i%24%5Cu7684%5Cu5b50%5Cu6811%5Cu4e2d%5Cuff0c%5Cu989c%5Cu8272%3Dx%5Cu7684%5Cu70b9%5Cu7684%5Cu4e2a%5Cu6570%5Cu3002%20%5Cr%5Cn%5Cr%5Cn%242%5C%5Cleq%20n%5C%5Cleq%2050000%24%2C%241%5C%5Cleq%20m%2CQ%5C%5Cleq%2050000%24%5Cr%5Cn%5Cr%5Cn%241%5C%5Cleq%20a_1%2Ca_2%2C...%2Ca_n%5C%5Cleq%20m%24%5Cr%5Cn%5Cr%5Cn%241%5C%5Cleq%20b_1%2Cb_2%2C...%2Cb_m%5C%5Cleq%20100%24%22%2C%22tags%22%3A%5B%5D%2C%22wantsTranslation%22%3Afalse%2C%22totalSubmit%22%3A15%2C%22totalAccepted%22%3A6%2C%22pid%22%3A%22CF960H%22%2C%22title%22%3A%22Santa%27s%20Gift%22%2C%22difficulty%22%3A6%2C%22type%22%3A%22CF%22%7D%2C%22contest%22%3Anull%2C%22discussions%22%3A%5B%5D%2C%22bookmarked%22%3Afalse%2C%22vjudgeUsername%22%3Anull%2C%22recommendations%22%3A%5B%5D%2C%22lastLanguage%22%3A%22%22%2C%22lastCode%22%3A%22%22%7D%2C%22currentTitle%22%3A%22Santa%27s%20Gift%22%2C%22currentTheme%22%3Anull%7D"));window._feConfigVersion=1572920822;</script>
<script src="https://cdn.luogu.com.cn/fe/loader.js?ver=20191106" charset="utf-8" defer></script>
</head>
<body>
<div id="app">
<div class="lg-container">
<article>
<h1>Santa&#039;s Gift</h1>
<h2>题意翻译</h2>
<div>给一棵$n$个点的有根树，每个点有一个颜色$a_i$，对于每种颜色有一个权值$b_i$。再给你一个常数$C$。
共进行$Q$次操作，操作分为两种：
- ```1 x y```把节点x的颜色修改为y
- ```2 x```对颜色x进行询问。求$\frac{\sum_{i=1}^n(S_i\times b_x-C)^2}{n}$，其中$S_i$是$i$的子树中，颜色=x的点的个数。
$2\leq n\leq 50000$,$1\leq m,Q\leq 50000$
$1\leq a_1,a_2,...,a_n\leq m$
$1\leq b_1,b_2,...,b_m\leq 100$</div>
<h2>题目描述</h2>
<div>Santa has an infinite number of candies for each of $ m $ flavours. You are given a rooted tree with $ n $ vertices. The root of the tree is the vertex $ 1 $ . Each vertex contains exactly one candy. The $ i $ -th vertex has a candy of flavour $ f_i $ .
Sometimes Santa fears that candies of flavour $ k $ have melted. He chooses any vertex $ x $ randomly and sends the subtree of $ x $ to the Bakers for a replacement. In a replacement, all the candies with flavour $ k $ are replaced with a new candy of the same flavour. The candies which are not of flavour $ k $ are left unchanged. After the replacement, the tree is restored.
The actual cost of replacing one candy of flavour $ k $ is $ c_k $ (given for each $ k $ ). The Baker keeps the price fixed in order to make calculation simple. Every time when a subtree comes for a replacement, the Baker charges $ C $ , no matter which subtree it is and which flavour it is.
Suppose that for a given flavour $ k $ the probability that Santa chooses a vertex for replacement is same for all the vertices. You need to find out the expected value of error in calculating the cost of replacement of flavour $ k $ . The error in calculating the cost is defined as follows.
$ $$$ Error\ E(k) =\ (Actual Cost\ –\ Price\ charged\ by\ the\ Bakers) ^ 2. $ $ </p><p>Note that the actual cost is the cost of replacement of one candy of the flavour $ k $ multiplied by the number of candies in the subtree.</p><p>Also, sometimes Santa may wish to replace a candy at vertex $ x $ with a candy of some flavour from his pocket.</p><p>You need to handle two types of operations: </p><ul> <li> Change the flavour of the candy at vertex $ x $ to $ w $ . </li><li> Calculate the expected value of error in calculating the cost of replacement for a given flavour $ k$$$.</div>
<h2>输入输出格式</h2>
<h3>输入格式</h3>
<br />
<div>The first line of the input contains four integers $ n $ ( $ 2 \leqslant n \leqslant 5 \cdot 10^4 $ ), $ m $ , $ q $ , $ C $ ( $ 1 \leqslant m, q \leqslant 5 \cdot 10^4 $ , $ 0 \leqslant C \leqslant 10^6 $ ) — the number of nodes, total number of different flavours of candies, the number of queries and the price charged by the Bakers for replacement, respectively.
The second line contains $ n $ integers $ f_1, f_2, \dots, f_n $ ( $ 1 \leqslant f_i \leqslant m $ ), where $ f_i $ is the initial flavour of the candy in the $ i $ -th node.
The third line contains $ n - 1 $ integers $ p_2, p_3, \dots, p_n $ ( $ 1 \leqslant p_i \leqslant n $ ), where $ p_i $ is the parent of the $ i $ -th node.
The next line contains $ m $ integers $ c_1, c_2, \dots c_m $ ( $ 1 \leqslant c_i \leqslant 10^2 $ ), where $ c_i $ is the cost of replacing one candy of flavour $ i $ .
The next $ q $ lines describe the queries. Each line starts with an integer $ t $ ( $ 1 \leqslant t \leqslant 2 $ ) — the type of the query.
If $ t = 1 $ , then the line describes a query of the first type. Two integers $ x $ and $ w $ follow ( $ 1 \leqslant  x \leqslant  n $ , $ 1 \leqslant  w \leqslant m $ ), it means that Santa replaces the candy at vertex $ x $ with flavour $ w $ .
Otherwise, if $ t = 2 $ , the line describes a query of the second type and an integer $ k $ ( $ 1 \leqslant k \leqslant m $ ) follows, it means that you should print the expected value of the error in calculating the cost of replacement for a given flavour $ k $ .
The vertices are indexed from $ 1 $ to $ n $ . Vertex $ 1 $ is the root.</div>
<h3>输出格式</h3>
<br />
<div>Output the answer to each query of the second type in a separate line.
Your answer is considered correct if its absolute or relative error does not exceed $ 10^{-6} $ .
Formally, let your answer be $ a $ , and the jury's answer be $ b $ . The checker program considers your answer correct if and only if $ \frac{|a-b|}{max(1,b)}\leqslant 10^{-6} $ .</div>
<h2>输入输出样例</h2>
<h3>输入样例 #1</h3>
<pre><code>3 5 5 7
3 1 4
1 1
73 1 48 85 89
2 1
2 3
1 2 3
2 1
2 3
</code></pre>
<h3>输出样例 #1</h3>
<pre><code>2920.333333333333
593.000000000000
49.000000000000
3217.000000000000
</code></pre>
<h2>说明</h2>
<div>For $ 1 $ -st query, the error in calculating the cost of replacement for flavour $ 1 $ if vertex $ 1 $ , $ 2 $ or $ 3 $ is chosen are $ 66^2 $ , $ 66^2 $ and $ (-7)^2 $ respectively. Since the probability of choosing any vertex is same, therefore the expected value of error is $ \frac{66^2+66^2+(-7)^2}{3} $ .
Similarly, for $ 2 $ -nd query the expected value of error is $ \frac{41^2+(-7)^2+(-7)^2}{3} $ .
After $ 3 $ -rd query, the flavour at vertex $ 2 $ changes from $ 1 $ to $ 3 $ .
For $ 4 $ -th query, the expected value of error is $ \frac{(-7)^2+(-7)^2+(-7)^2}{3} $ .
Similarly, for $ 5 $ -th query, the expected value of error is $ \frac{89^2+41^2+(-7)^2}{3} $ .</div>
</article>
</div>
</div>
</body>
</html>
